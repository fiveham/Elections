<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" href="/Elections/images/favicon/nc-rwb-check.png">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    
    <link rel="canonical" href="https://fiveham.github.io/Elections/2020/03/03/NC.html">
    <meta name="robots" content="index,follow">
    <meta name="description" content="Interactive election map of districts and candidates for state house and senate, 
                                      statewide offices, District Court, Superior Court, District Attorney, and municipal offices
                                      in North Carolina's partisan primaries on March 3rd, 2020">
    
    <meta property="og:image"
          content="http://raw.githubusercontent.com/fiveham/Elections/master/docs/images/og/nc-03-03-2020.png">
    <meta property="og:image:url"
          content="http://raw.githubusercontent.com/fiveham/Elections/master/docs/images/og/nc-03-03-2020.png">
    
    <!-- Sharing:
      Pinterest: media
    -->
    <meta property="og:image:secure_url"
          content="https://raw.githubusercontent.com/fiveham/Elections/master/docs/images/og/nc-03-03-2020.png">
    <meta property="og:image:alt"
          content="">
    <meta property="og:image:type"       content="image/png">
    <meta property="og:image:width"      content="1200">
    <meta property="og:image:height"     content="630">
    
    <!-- Sharing:
      Tumblr: canonicalUrl
    -->
    <meta property="og:url"              content="https://fiveham.github.io/Elections/2020/03/03/NC.html">
    
    <meta property="og:type"             content="website">
    <meta property="og:determiner"       content="">
    
    <!-- Sharing:
      Diaspora*: title
      LinkedIn: title
      MySpace: t (title)
      Skype: title
      -->
    <meta property="og:title"
          content="NC Primaries 3/3/20">
    
    <!-- Sharing:
      Buffer: text
      LinkedIn: summary
      MySpace: c ('content'?)
      Pinterest: description
      Reddit: title
    -->
    <meta property="og:description"
          content="Interactive election map of districts and candidates for state house and senate, 
                  statewide offices, district court and superior court judgeships, district attorney, and 
                  county/municipal offices">
    
    <meta property="og:locale" content="en_US">
    
    <meta name="twitter:card"        content="summary_large_image">
    <meta name="twitter:url"         content="https://fiveham.github.io/Elections/2019/11/16/LA.html">
    <meta name="twitter:title" content="NC Primaries 3/3/20">
    <meta name="twitter:description"
          content="Interactive election map of districts and candidates for state house and senate, 
                  statewide offices, district court and superior court judgeships, district attorney, and 
                  county/municipal offices">
    <meta name="twitter:image"
          content="http://raw.githubusercontent.com/fiveham/Elections/master/docs/images/og/la-11-16-2019.png">
    <meta name="twitter:image:alt"
          content="">
    
    <!-- Sharing:
      Tumblr: tags
    -->
    <meta property="tumblr:tags" content="election,map,voting">
    
    <title>Primaries March 3, 2020 - Interactive Election Map of North Carolina</title>
    
    <link rel="stylesheet" type="text/css" href="/Elections/css/fullpage-map.css">
    <link rel="stylesheet" type="text/css" href="/Elections/css/balloon-dimensions.css">
    <link rel="stylesheet" type="text/css" href="/Elections/css/balloon-guts.css">
    <link rel="stylesheet" type="text/css" href="/Elections/css/map-controls.css">
    <link rel="stylesheet" type="text/css" href="/Elections/css/geolocator.css">
    <link rel="stylesheet" type="text/css" href="/Elections/css/about-modal.css">
    <style>
      #party_goggles {
        width: 120px; /* To match width of basemap control */
      }
      
      #set-share {
        width: 120px;
        height: 38px;
        overflow: hidden;
      }
      #set-share > *,
      #settings,
      #about, 
      #sharing {
        float: left;
        width:  40px;
        height: 100%;
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      }
      
      #settings {
        left: 0;
        background-image: url('/Elections/images/options.png');
        background-size: 80%;
        background-position: 80%;
      }
      
      #about {
        left: 40px;
        background-image: url('https://maps.google.com/mapfiles/kml/shapes/info_circle.png');
        background-size: 75%;
      }
      
      #sharing {
        right: 0;
        background-image: url('/Elections/images/share.png');
        background-size: 65%;
        background-position: 30%;
      }
      
      .popup [data-tab] {
        display: none;
      }
      .popup[data-tab="settings"] [data-tab="settings"] {
        display: block;
      }
      .popup[data-tab="about"] [data-tab="about"] {
        display: block;
      }
      .popup[data-tab="share"] [data-tab="share"] {
        display: block;
      }
      
      /* Just for symmetry */
      .popup [data-tab="share"] {
        padding-right: 10px;
      }
      
      #sharing-buttons{
        margin-top: 10px;
      }
      
      #copy-sneak {
        position: relative; /* So that child elements position themselves w/r/t this element */
        display: inline-block;
        height: 40px;
        width:  40px;
        margin: 5px;
        margin-right: 2px;
      }
      
      #sharing-url,
      #copier {
        position: absolute;
        display: block;
      }
      
      #sharing-url {
        width: 50%;
        left: 25%;
        right: 25%;
        height: 50%;
        top: 25%;
        bottom: 25%;
        z-index: -1;
      }
      
      #copier {
        z-index: 1;
        top: 0;
        height: 100%;
        width: 100%;
        border-radius: 2px;
        background-image: url('/Elections/images/social/copy.png');
        background-position: center center;
        background-size: 65%;
        background-repeat: no-repeat;
      }
    </style>
  </head>
  <body>
    <!-- Geolocator Button -->
    <div id="geolocation" class="geolocate installed controls top" onclick="geolocate();" role="button" 
         title="Your location"></div>
    
    <!-- Layer-switcher dropdown -->
    <select id="layer-switcher" class="installed controls top text" onchange="reset_layers()" 
            title="Change the district set">
      <option value="house"         title="State House">State House</option>
      <option value="senate"        title="State Senate">State Senate</option>
      <option value="statewide"     title="Statewide offices">Statewide</option>
      <option value="district"      title="District Court">District Ct.</option>
      <option value="prosecutorial" title="District Attorneys">Prosecutorial</option>
      <option value="superior"      title="Superior Court">Superior Ct.</option>
      <option value="county"        title="Counties">County</option>
      <option value="municipal"     title="Cities and towns">Municipal</option>
      <option value="congress"      title="Congressional districts">Congress</option>
      <option value="vtd"           title="Precincts or voting tabulation districts">Precincts</option>
    </select>
    
    <!-- PPLkup Link
    <a id="pplkup" class="installed controls top text" rel="nofollow" target="_blank" title="NCSBE Polling Place Lookup Tool" 
       href="https://vt.ncsbe.gov/PPLkup">
      <span>Find Polling Place</span></a> -->
    
    <!-- Polling Place version dropdown -->
    <select id="pp-switcher" class="installed controls top text" onchange="reset_pps()" title="Show polling places">
      <option value=""      title="Don't show polling places">Polling Places</option>
      <option value="eday"  title="Election day polling places, 3/3/2020"           >Vote Mar 3</option>
      <option value="early" title="One-stop (early voting) sites, Feb 13 to Feb 29">Vote Early</option>
    </select>
    
    <!-- Party Goggles -->
    <select id="party_goggles" class="installed controls left text" title="Filter by partisan primary"
            onchange="put_on_goggles()">
      <option value=""    title="View all candidates">Primary</option>
      <option value="CST" title="Constitution Party" >CST</option>
      <option value="DEM" title="Democratic Party"   >DEM</option>
      <option value="GRE" title="Green Party"        >GRE</option>
      <option value="LIB" title="Libertarian Party"  >LIB</option>
      <option value="REP" title="Republican Party"   >REP</option>
    </select>
    
    <!-- Settings, About, and Sharing -->
    <div id="set-share" class="installed left bottom">
      <div id="settings" class="controls text" role="button" title="Options"        onclick="pop_tab('popup','settings')"></div>
      <div id="about"    class="controls text" role="button" title="About this map" onclick="pop_tab('popup','about')"></div>
      <div id="sharing"  class="controls text" role="button" title="Share this map" onclick="build_shares(); pop_tab('popup','share');"></div>
    </div>
    
    <!-- Settings, About, and Sharing Popup -->
    <div id="popup" class="installed popup" data-tab="about">
      <div role="button" class="closer" onclick="pop_tab('popup')">X</div>
      <div class="has-scrollbar">
        <div class="box" data-balloonish="dims guts">
          
          
          <div class="content" data-tab="settings">
            <p class="heading">Infowindow and District Color Settings</p>
            <p><input type="checkbox" id="ignore" onchange="tweak_settings()" checked="checked"><label for="ignore">Ignore 
              withdrawn/cancelled candidates</label></p>
            <p><input type="checkbox" id="multicand" onchange="tweak_settings()" checked="checked"><label for="multicand">When 
              filtering by party, ignore contests without more candidates than the number to vote for</label></p>
            <p><input type="checkbox" id="nonpart" onchange="tweak_settings()" checked="checked"><label for="nonpart">When filtering by party, include 
              non-partisan contests</label></p>
          </div>
          
          
          <div class="content" data-tab="share">
            <p class="heading">Share this map</p>
            <div id="sharing-buttons">
              <div id="copy-sneak">
                <input id="sharing-url" type="text" readonly class="sharing-url" onclick="this.setSelectionRange(0, this.value.length)">
                <div class="controls text" id="copier" title="Copy link to clipboard" onclick="copy_sharing_url();"></div></div>
            </div>
            
            <p class="heading">Pageload Options</p>
            <p>Change how the map starts off when loaded</p>
            <p><input type="checkbox" id="url_layer"  onchange="build_shares()"><label for="url_layer" >District type</label></p>
            <p><input type="checkbox" id="url_pp"     onchange="build_shares()"><label for="url_pp"    >Polling place type</label></p>
            <p><input type="checkbox" id="url_party"  onchange="build_shares()"><label for="url_party" >Primary</label></p>
            <p><input type="checkbox" id="url_bounds" onchange="build_shares()"><label for="url_bounds">Area in view</label></p>
            
          </div>
          
          
          <div class="content" data-tab="about">
            
            <p class="heading">NC Partisan Primaries, Mar 3 2020</p>
            <p>This interactive election map shows the districts, candidates, and polling places for the March 3, 2020 partisan 
              primaries in North Carolina. Candidates for a district's office(s) are shown in a popup infowindow when the 
              district is clicked.</p>
            <p>The district types include a statewide layer for statewide offices and presidential
              preference, a county layer for county offices, and a precinct layer for voting tabulation districts, though
              counties and the state are not districts and VTDs don't have elected offices.</p>
              
            <p>Candidates unopposed for their party's nomination are included in this map even though the offices
               for which they are running may not actually appear on their party's primary ballot.</p>
            
            <p class="heading">How to Use</p>
            <p>Aside from the obvious--panning, zooming, and clicking/tapping--change which type of 
              districts are shown, turn on either election day or early polling places, or filter 
              the map and candidates by choosing a partisan primary.</p>
            <p>There are also some fine-tuning controls in the settings menu (wrench icon).</p>
            <p>The geolocator button recenters and rescales the map onto the location reported 
              by your browser. Your location data is not sent anywhere.</p>
            
            <p class="heading">Parties</p>
            <p>This map uses three-letter abbreviations for political parties copied from the state elections board's candidate
              listing file.</p>
            <table>
              <tr><th>Abbreviation</th><th>Party Name</th></tr>
              <tr><td>CST</td><td>Constitution Party</td></tr>
              <tr><td>DEM</td><td>Democratic Party</td></tr>
              <tr><td>GRE</td><td>Green Party</td></tr>
              <tr><td>LIB</td><td>Libertarian Party</td></tr>
              <tr><td>REP</td><td>Republican Party</td></tr>
            </table>
            <p>These five are the only political parties the state of North Carolina officially recognizes.</p>
            
            
            <p class="heading">Nonpartisan Contests</p>
            <p>Some offices on the ballot do not show candidates' party affiliation. This map lists those candidates by 
              name only.</p>
            
            
            <p class="heading">Districts Within Counties and Municipalities</p>
            <p>Some local county and municipal offices are elected using districts within the county or city/town. Those sorts of 
              districts are not included in this map, but those offices and candidates are included for their respective county
              or municipality.</p>
            <p>Accounting for low-level districts in this map is nearly impossible to do fairly; so, finding out which 
              low-level districts apply to a given voter is left up to the user. Look up your sample ballot and districts in your
              <a href="https://vt.ncsbe.gov/RegLkup" title="Voter Lookup - NCSBE" target="_blank" rel="nofollow">voter registration
              information on the state elections board website.</a></p>
            
            <p class="heading">Voter ID?</p>
            <p><a href="https://www.ncsbe.gov/Voter-ID" rel="nofollow" target="_blank" title="NC state elections board voter ID page">
              Not for the March 3rd primary, no.</a></p>
            <p>The suit <i>NAACP v. Cooper</i>, which led to the <a href="http://dig.abclocal.go.com/wtvd/docs/voter%20ID%20order.pdf" 
              title="Court order (PDF)" target="_blank" rel="nofollow">injunction blocking voter ID requirements</a> for the primary, 
              is on appeal, which could reinstate the requirements for later elections this year.</p>
            
            <!--
            <p class="heading">Voter ID Requirement</p>
            <p>This will be the first election since <a target="_blank" rel="nofollow" title="NAACP v. McCrory"
               href="https://www.brennancenter.org/our-work/court-cases/north-carolina-naacp-v-mccrory">NAACP v. McCrory</a> where
               photo ID will be required to vote.</p>
            <p>A <a href="https://s3.amazonaws.com/dl.ncsbe.gov/Voter%20ID/ApprovalApplications/Approved%20Photo%20ID%20List%20December%202019.pdf"
            title="list of accepted voter IDs" target="_blank" rel="nofollow">list of accepted forms of ID</a> is available 
            <a href="https://www.ncsbe.gov/Voter-ID" target="_blank" rel="nofollow"
               title="NCSBE Voter ID FAQ page">on the State Elections Board website.</a></p>
            <p>Accepted IDs include <ul>
               <li><a href="https://www.ncsbe.gov/Portals/0/Voter%20ID/Forms/VoterID_Request_201904.pdf" rel="nofollow" target="_blank"
                  title="Voter ID request form">Voter ID card</a>
                  from your <a href="https://vt.ncsbe.gov/BOEInfo/" rel="nofollow" target="_blank" title="county elections board 
                  contact info">county board of elections</a>
               <li>Driver's license or non-operator ID (doesn't need to be a "REAL ID")<ul>
                  <li>from North Carolina
                  <li>From elsewhere in the US (but only if you registered to vote in a 90-day window before the election)</ul>
               <li>US Passport
               <li>Student ID from certain colleges and universities
               <li>Employee ID from certain charter schools, colleges, universities, local governments, and 
                   state government departments
               <li>Tribal enrollment card from <ul>
                  <li>a federal tribe (including but not limited to the EBCI)
                  <li>a state tribe<ul>
                    <li>Coharie
                    <li>Haliwa-Saponi
                    <li>Lumbee
                    <li>Sappony
                    <li>Waccamaw Siouan</ul></ul>
               <li>Military ID, veteran ID
               </ul></p>
            <p>Tribal enrollment cards and military/veteran ID may be expired or have no expiration date.</p>
            <p>All others must<ul>
               <li>Be valid and unexpired,
               <li>be expired for one year or less, or
               <li>have been unexpired on the voter's 65th birthday if they're 65 or older</ul></p> 
            -->
            
            <p class="heading">Referenda, Bonds, Ballot Issues</p>
            <p>Municipalities, counties, school districts, etc. may have yes/no questions on the ballot. These are not 
              included in this map if they exist, simply because it is difficult to discover them all in a fair and consistent way 
              across the state.</p>
            
            <p class="heading">Election Incidents, Voter Intimidation</p>
            <p>In the event of voter intimidation or other inappropriate stuff, there are several ways to report it as 
               an election incident. Here are some:</p>
            <ul>
            <li><a href="https://docs.google.com/forms/d/e/1FAIpQLSfFDJqx8zlzRWXSmNNpC5sEgqMguWsYf1Y_npmeet__E1SFZg/viewform"
                          title="NCBSE election incident report form" rel="nofollow" target="_blank">
                          NCSBE election incident report form</a>
            <li>ACLU Election Protection Hotline: 866-OUR-VOTE (866-687-8683)
            <li><a href="https://www.votingrightsinstitute.org/report/" rel="nofollow" target="_blank"
                   title="Report a Voting Rights Problem">Voting Rights Institute</a>
            <li><a href="https://www.justice.gov/crt/complaint/votintake/index.php" rel="nofollow" target="_blank"
                   title="Election Complaint Report">United State Dept. of Justice</a>
            <li><a href="https://www.pewtrusts.org/en/research-and-analysis/blogs/stateline/2018/11/05/report-voting-problems-on-election-day"
                   rel="nofollow" target="_blank" title="Report Voting Problems on Election Day">The Pew Charitable Trusts</a>
            </ul>
            
            
            <p class="heading">Office and Candidate Sequence</p>
            <p>Candidates for an office are listed with their party affiliation, sorted alphabetically. This typically differs 
               from the order on the ballot. The candidate's party is listed before their name so alphabetization
               clusters candidates by party.</p>
            <p>Statewide contests are sorted alphabetically within three unlabeled subsections: state executive offices, 
              state judicial offices, then federal offices.</p>
            
            
            <p class="heading">Incumbents?</p>
            <p>The map does not indicate whether a candidate currently occupies the office they're running for.</p>
            
            
            <p class="heading">Colors</p>
            <p>The colors mean nothing, for the most part.</p>
            <p>The shades of green and orange are used purely to help distinguish adjacent shapes. Orange and green were chosen to 
              avoid partisan implications.</p>
            <p>A grayer version of a district's color is used if that district has no corresponding election on March 3rd.
              </p>
            
            <!--
            <p class="heading">Why have district lines moved?</p>
            <p>State house and senate districts moved due to a court order coming from the case <a rel="nofollow" target="_blank" 
               href="https://www.brennancenter.org/our-work/court-cases/common-cause-v-lewis"><i>Common Cause v. Lewis</i></a> due 
               to partisan gerrymandering.</p>
            <p>Congressional districts moved due to the case <a rel="nofollow" target="_blank"
               href="https://www.brennancenter.org/our-work/court-cases/harper-v-lewis"><i>Harper v. Lewis</i></a> due to partisan
               gerrymandering.</p>
            <p>A few prosecutorial districts were set to change over the next few election cycles by <a rel="nofolllow" target="_blank"
               href="https://www.ncleg.gov/BillLookUp/2017/H717">Session Law 2018-121</a>, from June 2018.</p>
            -->
            
            <p class="heading">Sources</p>
            
            <p class="source">Candidates</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="NCSBE downloads - 2020 candidate filing"
                  href="https://dl.ncsbe.gov/?prefix=Elections/2020/Candidate%20Filing/">
                  State Elections Board: Candidate Listing File (csv, 3.1MB)</a></ul>
            
            <p class="source">District lines: Congress</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="Court-ordered redistricting bill"
                  href="https://www.ncleg.gov/BillLookUp/2019/H1029">
                  NC Legislature: H1029 (SL 2019-249)</a></ul>
            
            <p class="source">District lines: State House</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="Court-ordered redistricting bill"
                  href="https://www.ncleg.gov/BillLookUp/2019/H1020">
                  NC Legislature: H1020 (SL 2019-220)</a></ul>
            
            <p class="source">District lines: State Senate</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="Court-ordered redistricting bill"
                  href="https://www.ncleg.gov/BillLookUp/2019/S692">
                  NC Legislature: S692 (SL 2019-219)</a></ul>
            
            <p class="source">District lines: District Court; Prosecutorial (district attorney); Superior Court</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="Spontaneous redistricting bill"
                  href="https://www.ncleg.gov/BillLookUp/2017/H717">
                  NC Legislature: H717 (SL 2018-121)</a></ul>
            
            <p class="source">County lines</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="County line shapefile"
                  href="https://dl.ncsbe.gov/?prefix=ShapeFiles/CountyBoundary/">
                  State Elections Board</a></ul>
            
            <p class="source">Municipal borders</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="download NC places shapefile"
                  href="https://www.census.gov/cgi-bin/geo/shapefiles/index.php?year=2019&layergroup=Places">
                  US Census Bureau</a></ul>
            
            <p class="source">Precincts</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="download NC places shapefile"
                  href="https://dl.ncsbe.gov/?prefix=PrecinctMaps/">
                  State Elections Board</a></ul>
            
            <p class="source">Early voting sites</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="download NC places shapefile"
                  href="https://vt.ncsbe.gov/ossite">
                  NCSBE One-Stop Site Lookup</a></ul>
            
            <p class="source">Election day polling places</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                  title="download NC places shapefile"
                  href="https://vt.ncsbe.gov/PPLkup">
                  NCSBE Polling Place Lookup</a></ul>
            
            <!--
            <p class="source">Accepted voter IDs</p>
            <ul>
              <li><a target="_blank" rel="nofollow"
                title="Accepted voter ID list"
                href="https://s3.amazonaws.com/dl.ncsbe.gov/Voter%20ID/ApprovalApplications/Approved%20Photo%20ID%20List%20December%202019.pdf">
                Accepted voter ID list (PDF)</a>
              <li><a target="_blank" rel="nofollow"
                title="NCSBE Voter ID info page"
                href="https://www.ncsbe.gov/Voter-ID">
                State Elections Board</a></ul> -->
            
            
            <p class="heading">Project on Github</p>
            <p>This map is one of <a href="https://github.com/fiveham/Elections" target="_blank" rel="nofollow" 
                                     title="Elections repository on Github">several election maps of NC and other states.</a></p>
            <p>To report a bug, request a feature, etc. <a href="https://github.com/fiveham/Elections/issues/new" 
               title="Submit a new issue" rel="nofollow" target="_blank">submit an issue.</a></p>
            
          </div>
        </div>
      </div>
    </div>
    
    <!-- The Map -->
    <div id="map"></div>
    
    <script>
      var party_to_index = {
        CST: 1, 
        DEM: 2, 
        GRE: 3, 
        LIB: 4, 
        REP: 5};
      var layer_to_index = {
        house        : 0, 
        senate       : 1, 
        statewide    : 2,
        district     : 3, 
        prosecutorial: 4,
        superior     : 5,
        county       : 6, 
        municipal    : 7, 
        congress     : 8,
        vtd          : 9};
      var pp_to_index = {
        eday:  1,
        early: 2
      };
      
      var layers = [
        {file:'house',         data:null},
        {file:'senate',        data:null},
        {file:'state',         data:null},
        {file:'dcd',           data:null},
        {file:'prosecutorial', data:null},
        {file:'scd',           data:null},
        {file:'county',        data:null},
        {file:'municipal',     data:null},
        {file:'congress',      data:null},
        {files: ['https://fiveham.github.io/Elections/resources/2020/03/03/NC/vtd0.kmz?', 
                 'https://fiveham.github.io/Elections/resources/2020/03/03/NC/vtd1.kmz?', 
                 'https://fiveham.github.io/Elections/resources/2020/03/03/NC/vtd2.kmz?', 
                 'https://fiveham.github.io/Elections/resources/2020/03/03/NC/vtd3.kmz?', 
                 'https://fiveham.github.io/Elections/resources/2020/03/03/NC/vtd4.kmz?'],  data:null}];
      var map;
      var infowindow;
      var party_goggles; // Specify a party, ignore all candidates not of that party
      
      var saturation_fraction = 0.35;
      
      var reg_rgb = {
        0: '#cccccc',
        1: '#b6d7a8',
        2: '#b45f06',
        3: '#6aa84f',
        4: '#f6b26b'};
      var empty_rgb = {
        1: desaturate(reg_rgb[1]),
        2: desaturate(reg_rgb[2]),
        3: desaturate(reg_rgb[3]),
        4: desaturate(reg_rgb[4])};
      
      var full_party_name = {'CST': 'Constitution',
                             'DEM': 'Democratic',
                             'GRE': 'Green',
                             'LIB': 'Libertarian',
                             'REP': 'Republican'};
      
      var ncCenter = {lat: 35.5, lng: -79.9};
      var ncBounds = {west: -82.745, east: -75.887, south: 34.805, north: 36.562};
      
      var triggers = ["tilesloaded", "mousemove", "zoom_changed", "idle"];
      var widgets = [{id: 'geolocation',    where: 1  /*google.maps.ControlPosition.TOP_LEFT*/}, 
                     {id: 'layer-switcher', where: 1  /*google.maps.ControlPosition.TOP_LEFT*/},
                     /*{id: 'pplkup',         where: 1}, */
                     {id: 'pp-switcher',    where: 1},
                     {id: 'party_goggles',  where: 5  /* LEFT TOP */ },
                     {id: 'set-share',      where: 6  /*google.maps.ControlPosition.LEFT_BOTTOM*/ },
                     {id: 'popup',          where: 13 /*google.maps.ControlPosition.CENTER*/}];
      
      var share_sites = ['facebook', 'reddit',   'twitter',  'linkedin', 'tumblr',  'pinterest', 'googleplus', 
                         'buffer',   'diaspora', 'mix',      'myspace',  'blogger', 'wordpress', 'quora'];
      
      function desaturate(hexcode){
        var r = parseInt(hexcode.slice(1,3), 16)/255;
        var g = parseInt(hexcode.slice(3,5), 16)/255;
        var b = parseInt(hexcode.slice(5), 16)/255;
        var max = Math.max(r,g,b);
        var min = Math.min(r,g,b);
        var delta = max - min;
        var h = (delta === 0 ? 0 : (max === r ? (g - b) / delta : (max === g ? 2 + (b - r) / delta : 4 + (r - g) / delta))) * 60;
        var l = (max + min) / 2;
        var s = delta === 0 ? 0 : (l < 0.5 ? delta / (max + min) : (l > 0.5 ? delta / (2 - max - min) : false));
        var s2 = s * saturation_fraction;
        var C = (1-Math.abs(2*l-1))*s2;
        var X = C*(1-Math.abs((h / 60)%2-1));
        r = g = b = 0;
        if(h < 60){
          r = C;
          g = X;
        } else if(h < 120){
          r = X;
          g = C;
        } else if(h < 180){
          g = C;
          b = X;
        } else if(h < 240){
          g = X;
          b = C;
        } else if(h < 300){
          r = X;
          b = C;
        } else{
          r = C;
          b = X;
        }
        var m = l-C/2;
        r = Math.round((r + m) * 255).toString(16);
        g = Math.round((g + m) * 255).toString(16);
        b = Math.round((b + m) * 255).toString(16);
        r = r.length < 2 ? '0' + r : r;
        g = g.length < 2 ? '0' + g : g;
        b = b.length < 2 ? '0' + b : b;
        return '#' + r + g + b;
      }
      
      function recolor_polygons(){
        var d = layers[document.getElementById('layer-switcher').selectedIndex].data;
        if(d && d.setStyle){ // the precinct layer does not have a setStyle method
          d.setStyle(color_func);
        }
      }
      
      function recolor_pps(){
        var d = pp_layers[document.getElementById('pp-switcher').selectedIndex].data;
        if(d){
          d.setStyle(pp_style_func);
        }
      }
      
      function fill_color(feature){
        var color = feature.getProperty('color');
        var empty = feature.getProperty('contests').filter(contest_in_goggles).length == 0;
         
        return empty ? empty_rgb[color] : reg_rgb[color];
      }
      
      var icon_color_urls = {
        4: 'https://maps.google.com/mapfiles/kml/paddle/purple-circle.png',
        3: 'https://maps.google.com/mapfiles/kml/paddle/grn-circle.png',
        2: 'https://maps.google.com/mapfiles/kml/paddle/ylw-circle.png',
        1: 'https://maps.google.com/mapfiles/kml/paddle/blu-circle.png'
      };
      
      function pp_style_func(feature){
        var color = feature.getProperty('color') || feature.getProperty('vtds')[0].color;
        
        var style = {
          icon: {
            url: icon_color_urls[color],
            size: new google.maps.Size(64, 64),
            anchor: new google.maps.Point(15, 30),
            scaledSize: new google.maps.Size(30, 30)
          },
          //icon: icon_color_urls[color],
          //visible: true,
          //cursor: null,
          //title: null, // mouseover text
          //shape: null, // hitbox for clicking
          clickable: true,
          zIndex: 1
        };
        
        return style;
      }
      
      function color_func(feature){
        var color = feature.getProperty('color');
        var empty = feature.getProperty('contests').filter(contest_in_goggles).length == 0;
        
        var style = {
          fillColor: (empty ? empty_rgb : reg_rgb)[color],
          fillOpacity: empty ? 0.4 : 0.5,
          strokeColor: "#cccccc",
          strokeOpacity: 0,
          strokeWeight: 0,
          clickable: true,
          zIndex: 0
        };
        
        return style;
      }
      
      function put_on_goggles(){
        if(infowindow){
          infowindow.close();
        }
        var sel = document.getElementById('party_goggles');
        party_goggles = sel.options[(sel.selectedIndex)].value;
        recolor_polygons();
      }
      
      function get_url_params(){
        var url = window.location.href;
        var q = url.indexOf("?");
        var h = ((url.indexOf("#") + 1) || url.length + 1) - 1;
        var params = (q == -1
            ? []
            : url.slice(q+1,h).split("&"));
        var param_dict = {};
        for(var i = 0; i < params.length; i++){
          var kv = params[i].split("=");
          param_dict[kv[0]] = kv[1] ? kv[1] : null;
        }
        return param_dict;
      }
      
      function candidate_table(candidates){
        var rows = [];
        for(var i=0; i<candidates.length; i++){
          var party = candidates[i].party;
          var name = candidates[i].name;
          if(!party){ /* Nonpartisan offices */
            rows.push('<tr><td>' + name + '</td></tr>');
          } else{
            rows.push('<tr><td>' + party + '</td><td>' + name + '</td></tr>');
          }
        }
        return rows;
      }
      
      function candidate_in_goggles(candidate){
        // If we're ignoring withdrawn/cancelled candidates 
        // and the candidate is withdrawn/cancelled, then
        // the candidate is not visible
        if(document.getElementById('ignore').checked && candidate.name.split(' ').includes('-')){
          return false;
        }
        
        // If party goggles aren't on, then the candidate (if not removed in the previous test) 
        // is visible
        if(!party_goggles){
          return true;
        }
        
        // The party goggles are definitely on.
        // If the candidate is in the goggle'd party, they're visible
        var cand_party = candidate.party;
        if(party_goggles === cand_party){
          return true;
        }
        
        // If the candidate has no party listed and the nonpartisan contest
        // checkbox is checked, the candidate is visible
        if(!cand_party && document.getElementById('nonpart').checked){
          return true;
        }
        
        return false
      }
      
      function contest_text(contest){
        var name = contest.name;
        var vote_for = contest.vote_for;
        var vf = vote_for === 1 ? '' : '<br> (choose ' + vote_for + ')';
        var candidates = contest.candidates.filter(candidate_in_goggles);
        return '<b>' + name + '</b>' + vf + '<br><br><table>' + candidate_table(candidates).join('') + '</table>';
      }
      
      function contest_in_goggles(contest){
        if(!party_goggles){
          return true;
        } else{
          var sub_min = document.getElementById('multicand').checked ? contest.vote_for : 0; //Not the minimum, but the minimum minus 1
          return contest.candidates.filter(candidate_in_goggles).length > sub_min;
        }
      }
      
      function pp_balloon_text(feature){
        return feature.getProperty('hours') ? os_balloon_text(feature) : ed_balloon_text(feature);
      }
      
      function get_directions_url(addr1, addr2){
        return 'https://www.google.com/maps/dir//' + encodeURI(addr1 + '\n' + addr2);
      }
      
      function os_balloon_text(feature){
        var name   = feature.getProperty('Name');
        var addr1  = feature.getProperty('SiteAddressStreet');
        var addr2  = feature.getProperty('SiteAddressCSZ');
        var hours  = feature.getProperty('hours');
        var county = feature.getProperty('county').name;
        var directions_url = get_directions_url(addr1, addr2);
        
        var content = 'One-Stop (Early Voting) Site<br>';
        content += '<b>' + name + '</b><br>';
        
        //add county specifier if county name not in site name
        if(!name.toUpperCase().includes(county.toUpperCase())){
          content += county + ' County<br>';
        }
        
        content += '<br>';
        content += '<a href="' + directions_url + '" title="driving directions" target="_blank">' + addr1 + '<br>';
        content += addr2 + '</a><br><br>';
        
        content += '<b>Hours of Operation</b><br>';
        content += '<table>';
        
        var hours_obj = {};
        for(var i=0; i<hours.length; i++){
          var hour = hours[i];
          hours_obj[hour[0]] = [hour[1], hour[2]];
        }
        
        for(var i=0; i<os_days.length; i++){
          var key = os_days[i];
          var value = hours_obj[key];
          
          var terms = key.split(' ');
          var row = '<tr><td>'+terms[0]+'</td><td>'+terms[1]+'</td><td>'+terms[2]+'</td>';
          if(value){
            var open  = parse_time(value[0]);
            var close = parse_time(value[1]);
            row += '<td>'+open+'</td><td>-</td><td>'+close+'</td></tr>';
          } else{
            row += '<td colspan="3" style="text-align:center;"><i>Closed</i></td></tr>';
          }
          content += row;
        }
        
        content += '</table>';
        
        return content;
      }
      
      var os_days = ['Thu 13 Feb', 'Fri 14 Feb', 'Sat 15 Feb', 'Sun 16 Feb', 'Mon 17 Feb', 'Tue 18 Feb', 'Wed 19 Feb', 
                     'Thu 20 Feb', 'Fri 21 Feb', 'Sat 22 Feb', 'Sun 23 Feb', 'Mon 24 Feb', 'Tue 25 Feb', 'Wed 26 Feb', 
                     'Thu 27 Feb', 'Fri 28 Feb', 'Sat 29 Feb'];
      
      function parse_time(time){
        var hour = time.slice(0,2);
        var h = parseInt(hour, 10);
        var min  = time.slice(2);
        var meridiem = h > 12 ? 'PM' : 'AM';
        if(min == '00'){
          min = '';
        } else{
          min = ':' + min;
        }
        
        if(h === 0){
          hour = '12';
        } else if(h > 12){
          hour = '' + (h-12);
        } else{
          hour = '' + h;
        }
        
        return hour + min + ' ' + meridiem;
      }
      
      function ed_balloon_text(feature){
        var name = feature.getProperty('name');
        var addr1 = feature.getProperty('addr1');
        var addr2 = feature.getProperty('addr2');
        var vtds = feature.getProperty('vtds');
        var directions_url = get_directions_url(addr1, addr2);
        
        var content = '3/3/2020 Polling Place<br><b>' + name + '</b><br><br>';
        
        content += '<a href="' + directions_url + '" title="driving directions" target="_blank">' + addr1 + '<br>';
        content += addr2 + '</a><br><br>';
        
        if(vtds.length > 1){
          content += '<b>Precincts</b>:<ul>';
          for(var i=0; i<vtds.length; i++){
            content += '<li>' + precinct_link(vtds[i]);
          }
          content += '</ul>';
        } else {
          content += '<b>Precinct</b>: ' + precinct_link(vtds[0]);
        }
        
        return content;
      }
      
      function precinct_link(v){
        var html = '<a title="NCSBE Polling Place Lookup" target="_blank" ';
        html += 'href="https://vt.ncsbe.gov/PPLkup/PollingPlaceResult/?CountyID='+v.county.id;
        html += '&PollingPlaceID='+v.PollingPlaceID+'">';
        html += v.Description; // Or perhaps .Label
        html += '</a>'
        return html;
      }
      
      function balloon_text(feature){
        var party = document.getElementById('party_goggles').value;
        
        var start = '';
        if(party){
          start = full_party_name[party] + ' party';
          if(document.getElementById('multicand').checked){
            start += ' primary';
          }
          if(document.getElementById('nonpart').checked){
            start += ' and non-partisan';
          }
          start += ' candidates';
        } else{
          start = 'Candidates';
        }
        
        return start + ' for<br>' + _balloon_text(feature);
      }
      
      function _balloon_text(feature){
        var title = feature.getProperty('title');
        
        var all_contests = feature.getProperty('contests');
        if(all_contests.length == 0){
          if(title.includes('Census-designated place')){
            return '<b>' + title + '</b><br><br><i>A CDP does not have its own government</i>';
          }
          return '<b>' + title + '</b><br><br><i>No elections pertain to this district on 3/3/2020</i>';
        }
        
        var contests = all_contests.filter(contest_in_goggles);
        
        switch(contests.length){
          case 0:
            return '<b>' + title + '</b><br><br><i>No ' + full_party_name[party_goggles] + ' party primary for this district for 3/3/2020</i>';
          case 1:
            var pointer = document.getElementById('layer-switcher').selectedIndex;
            if(pointer === 0 || pointer === 1 || pointer === 8){
               return contest_text(contests[0]);
            } else{
              return '<b>' + title + '</b><br><br>' + contest_text(contests[0]);
            }
          default:
            var things = ['<b>' + title + '</b>'];
            for(var i=0; i<contests.length; i++){
              things.push(contest_text(contests[i]));
            }
            return things.join('<br><br>');
        }
      }
      
      var last_click_event;
      
      function district_clicked(event){
        last_click_event = event;
        
        var content = balloon_text(event.feature);
        
        if(infowindow){
          infowindow.close();
        }
        infowindow = new google.maps.InfoWindow({
          content: content,
          position: event.latLng
        });
        infowindow.open(map);
      }
      
      function pp_clicked(event){
        last_click_event = event;
        
        var content = pp_balloon_text(event.feature);
        if(pp_infowindow){
          pp_infowindow.close();
        }
        pp_infowindow = new google.maps.InfoWindow({
          content: content,
          position: event.latLng,
          pixelOffset: new google.maps.Size(0, -30)
        });
        pp_infowindow.open(map);
      }
      
      function get_bounds(params){
        var w = parseFloat(params.west);
        var e = parseFloat(params.east);
        var s = parseFloat(params.south);
        var n = parseFloat(params.north);
        
        return (isNaN(w) || isNaN(e) || isNaN(s) || isNaN(n) || w < -180 || e > 180 || s < -90 || n > 90 || w > e || s > n 
                ? ncBounds 
                : {east: e, west: w, south: s, north: n});
      }
      
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: ncCenter,
          mapTypeId: 'hybrid',
          mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
          },
          tilt: 0
        });
        
        add_widgets();
        
        var params = get_url_params()
        var bounds = get_bounds(params);
        map.fitBounds(bounds);
        
        //turn first layer(s) on
        var layer = params.layer;
        document.getElementById('layer-switcher').selectedIndex = layer ? layer_to_index[layer] : 0;
        
        var pp = params.pp;
        document.getElementById('pp-switcher').selectedIndex = pp ? pp_to_index[pp] : 0;
        
        reset_layers();
        reset_pps();
        
        
        // If params specify a party, switch to it and manually recolor
        var party = params.party;
        if(party){
          document.getElementById('party_goggles').selectedIndex = party_to_index[party] || 0;
          put_on_goggles();
        }
      }
      
      function reset_layers(){
        if(infowindow){
          infowindow.close();
        }
        for(var i = 0; i < layers.length; i++){
          var d = layers[i].data;
          if(d){
            d.setMap(null);
          }
        }
        var index = document.getElementById('layer-switcher').selectedIndex;
        var l = layers[index];
        if(!l.data){
          if(l.file){
            l.data = new google.maps.Data();
            l.data.loadGeoJson('/Elections/resources/2020/03/03/NC/' + l.file + '.geo.json');
            l.data.addListener('click', district_clicked);
          } else{
            l.data = new Layer(l.files, kmllayer);
          }
        }
        l.data.setMap(map);
        recolor_polygons();
      }
      
      function trim_float(f){
        var s = '' + f;
        var i = s.indexOf('.');
        if(i === -1){
          return s;
        }
        return s.slice(0, i+4);
      }
      
      function gen_sharing_url(){
        var url = location.href;
        var q = url.indexOf("?");
        if(q < 0){
          q = url.length;
        }
        url = url.slice(0,q);
        
        var bounds = map.getBounds().toJSON();
        var center = map.getCenter().toJSON();
        
        var x = center.lng;
        var y = center.lat;
        
        var w = bounds.west;
        var e = bounds.east;
        var s = bounds.south;
        var n = bounds.north;
        
        var radius = Math.min(x-w, e-x, n-y, y-s) / 2;
        var west = x - radius;
        var east = x + radius;
        var south = y - radius;
        var north = y + radius;
        
        var url_bounds = 'south=' + trim_float(south) + '&west=' + trim_float(west) + '&north=' + trim_float(north) + '&east=' + trim_float(east);
        var url_layer  = 'layer=' + document.getElementById('layer-switcher').value;
        
        var pp     = document.getElementById('pp-switcher');
        pp = pp ? pp.value : '';
        var url_pp = pp ? 'pp=' + pp : '';
        
        var party  = document.getElementById('party_goggles').value;
        var url_party = party ? 'party=' + party : '';
        
        var sharing_url = url;
        
        var parts = [];
        if(url_bounds && document.getElementById('url_bounds').checked){
          parts.push(url_bounds);
        }
        if(url_layer && document.getElementById('url_layer').checked){
          parts.push(url_layer);
        }
        if(url_party && document.getElementById('url_party').checked){
          parts.push(url_party);
        }
        if(url_pp && document.getElementById('url_pp').checked){
          parts.push(url_pp);
        }
        
        if(parts.length >= 1){
          sharing_url += '?' + parts[0];
        }
        for(var i=1; i<parts.length; i++){
          sharing_url += '&' + parts[i];
        }
        
        return sharing_url;
      }
      
      function copy_sharing_url(){
        var share = document.getElementById('sharing-url');
        share.select();
        document.execCommand('copy');
      }
      
      function remove_share_buttons(parent){
        var kids = parent.children;
        var to_kill = [];
        for(var i=0; i<kids.length; i++){
          var kid = kids[i];
          if(kid.id && kid.id.startsWith('share-')){
            to_kill.push(kid);
          }
        }
        to_kill.forEach(function(x){ x.remove(); });
      }
      
      function build_shares(){
        var share = document.getElementById('sharing-url');
        share.value = gen_sharing_url();
        var parent = document.getElementById('sharing-buttons');
        remove_share_buttons(parent);
        add_share_buttons(parent, share_sites, share.value);
      }
      
      function tweak_settings(){
        recolor_polygons();
        
        // If there is an infowindow object and if it's displayed on a map
        if(infowindow && infowindow.getMap() && last_click_event){
          district_clicked(last_click_event);
        }
      }
      
      var pp_infowindow = null;
      var pp_layers = [{data:null}, 
                       {data:null, file:'pollingplaces'}, 
                       {data:null, file:'ossite'}];
      
      function reset_pps() {
        if(pp_infowindow){
          pp_infowindow.close();
        }
        for(var i = 0; i < pp_layers.length; i++){
          var d = pp_layers[i].data;
          if(d){
            d.setMap(null);
          }
        }
        
        var index = document.getElementById('pp-switcher').selectedIndex;
        if(index){ // index 0 means turn them off
          var p = pp_layers[index];
          if(!p.data){
            p.data = new google.maps.Data();
            p.data.loadGeoJson('/Elections/resources/2020/03/03/NC/' + p.file + '.geo.json');
            p.data.addListener('click', pp_clicked);
          }
          p.data.setMap(map);
        }
        recolor_pps(); // Don't know if needed
      }
    </script>
    <script src="/Elections/js/geolocator.js"></script>
    <script src="/Elections/js/popup.js"></script>
    <script src="/Elections/js/add-widgets.js"></script>
    <script src="/Elections/js/kmllayer.js"></script>
    <script src="/Elections/js/layer.js"></script>
    <script src="/Elections/js/share-buttons.js"></script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAQzE_F2ZqhXc_tIW4sfBOJBOsAKITo2JA&callback=initMap">
    </script>
  </body>
</html>
